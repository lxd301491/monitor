import t from"axios";import e from"pako";import n from"localforage";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function o(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var i=function(){return(i=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function s(t,e,n,r){var o,i=arguments.length,s=i<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(s=(i<3?o(s):i>3?o(e,n,s):o(e,n))||s);return i>3&&s&&Object.defineProperty(e,n,s),s}function a(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{c(r.next(t))}catch(t){i(t)}}function a(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){t.done?o(t.value):new n((function(e){e(t.value)})).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function c(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function u(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}var h={consume:{before:function(){},after:function(){}},track:{before:function(){},after:function(){}}};function p(t,e,n){return{value:function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return h[e]&&h[e].before.apply(this,t),n.value.apply(this,t)}}}function f(t,e,n){return{value:function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return a(this,void 0,void 0,(function(){var r;return c(this,(function(o){switch(o.label){case 0:return[4,n.value.apply(this,t)];case 1:return r=o.sent(),h[e]&&h[e].after.apply(this,[r]),[2,r]}}))}))}}}function l(t,e,n,r){var o=window||global||void 0;if(!o)throw new ReferenceError("the top object is not exist");o._replace_center_||(o._replace_center_={});var i=r?o._replace_center_[r]?o._replace_center_[r]:o._replace_center_[r]={}:o._replace_center_;i[e]||(i[e]=t[e],t[e]=n)}function d(t,e,n){var r=window||global||void 0;if(!r)throw new ReferenceError("the top object is not exist");r._replace_center_||(r._replace_center_={});var o=n?r._replace_center_[n]?r._replace_center_[n]:r._replace_center_[n]={}:r._replace_center_;r._replace_center_[e]&&(t[e]=o[e],delete o[e])}function v(){return i(i(i({},function(){var t=m("uni");if(!t){t=function(t){t=t||10;for(var e="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz123456789",n=e.length,r="",o=0;o<t;o++)r+=e.charAt(Math.floor(Math.random()*n));return r+"_"+(new Date).getTime()}(10);var e=new Date;e.setDate(e.getDate()+864e5),document.cookie="uni="+t+";domain="+document.domain+";path=/;expires="+e.toGMTString()}return{uni:t}}()),w()),{page:window.location.href,uId:m("uId")||"",rId:m("rId")||"",msg:"",ms:"unkown",ml:"info",dId:m("deviceId")||"",dt:m("deviceType")||"",sys:m("sys")||"",sv:m("sysVersion")||"",sw:y().w,sh:y().h,v:"1.1.0"})}function y(){return{w:document.documentElement.clientWidth||document.body.clientWidth,h:document.documentElement.clientHeight||document.body.clientHeight}}function m(t){var e,n=new RegExp("(^| )"+t+"=([^;]*)(;|$)");return(e=document.cookie.match(n))?e[2]:null}function w(){var t=navigator.connection;if(!t)return{ct:navigator.onLine?"online":"offline"};var e=t.rtt,n=t.downlink;return{ct:t.effectiveType,cs:n+"Mb/s",cr:e+"ms",csa:t.saveData}}function g(t,e,n){window.addEventListener&&window.addEventListener(t,(function r(o){n&&window.removeEventListener(t,r,!0),e.call(this,o)}),!0),window.attachEvent&&window.attachEvent("on"+t,(function r(o){n&&window.detachEvent("on"+t,r),e.call(this,o)}))}function b(t,e){window.removeEventListener&&window.removeEventListener(t,e),window.detachEvent&&window.detachEvent(t,e)}function k(t,e){var n;CustomEvent?n=new CustomEvent(t,{detail:e}):((n=window.document.createEvent("HTMLEvents")).initEvent(t,!1,!0),n.detail=e),window.dispatchEvent(n)}function E(t){return(t?_(t.replace(/^#\/?/,"")):"")||"[index]"}function _(t){return t.replace(/^(https?:)?\/\//,"").replace(/\?.*$/,"")}function S(t,e){t.track(i(i({},v()),{dot:document.title,dol:location.href,dr:document.referrer,dpr:window.devicePixelRatio,de:document.charset,page:e||window.location.href,ms:"pv",ml:"info"}))}var T=function(){function t(t){this.store=t}return t.prototype.mountStore=function(t){this.store=t},t.prototype.track=function(t){return a(this,void 0,void 0,(function(){return c(this,(function(e){return t=i(i({},t),w()),this.store&&this.store.push(t),[2,this]}))}))},s([p,f],t.prototype,"track",null),t}(),x=function(){function t(t){this.nums=[],this.reserved=t}return t.prototype.get=function(){var t=this,e=Date.now();return this.nums=this.nums.filter((function(n){return n>e-1e3*t.reserved})),this.nums.length},t.prototype.increase=function(){var t=this,e=Date.now();this.nums=this.nums.filter((function(n){return n>e-1e3*t.reserved})),this.nums.push(Date.now())},t.prototype.decrease=function(){this.nums.shift()},t.prototype.reset=function(){this.nums=[]},t}(),H=function(){function t(t){void 0===t&&(t=Date.now()),this.startTime=t}return t.prototype.canPass=function(t){return!0},t.prototype.checkout=function(t){},t}(),L=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.canPass=function(t){var e=parseInt(t.thresholdForHalfOpen[0]);return t.getCount()<=e},e.prototype.checkout=function(t){t.getCount()>parseInt(t.thresholdForHalfOpen[0])?t.setState(new C):t.setState(new M)},e}(H),C=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.canPass=function(){return!1},e.prototype.checkout=function(t){var e=1e3*t.idleTimeForOpen;Date.now()>=this.startTime+e&&t.setState(new L)},e}(H),M=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.canPass=function(t){return!0},e.prototype.checkout=function(t){t.getCount()>=parseInt(t.thresholdForOpen[0])&&t.setState(new C)},e}(H),I=function(){function t(t,e,n){void 0===t&&(t="1/60"),void 0===e&&(e=300),void 0===n&&(n="1/60"),this.idleTimeForOpen=e,this.thresholdForOpen=t.split("/"),this.thresholdForHalfOpen=n.split("/"),this.counter=new x(Math.max(parseInt(this.thresholdForOpen[1]),parseInt(this.thresholdForHalfOpen[1]))),this.state=new M}return t.prototype.getStateName=function(){return/^function\s(.*)\(/.exec(this.state.constructor+""),RegExp.$1},t.prototype.getState=function(){return this.state},t.prototype.setState=function(t){this.state=t},t.prototype.reset=function(){this.counter.reset()},t.prototype.canPass=function(){return this.getState().checkout(this),this.getState().canPass(this)},t.prototype.count=function(){this.counter.increase()},t.prototype.getCount=function(){return this.counter.get()},t.prototype.getDuration=function(){return(Date.now()-this.state.startTime)/1e3},t}(),O=function(){function n(e,n,r,o,i){if(void 0===r&&(r="image"),void 0===o&&(o=t),void 0===i&&(i=!0),this.abnormalBreaker=new I("5/60",300,"0/60"),"xhr"===r&&!XMLHttpRequest)throw ReferenceError("EmitType is XHR,but XMLHttpRequest is undefined");if("fetch"===r&&!o)throw ReferenceError("EmitType is FETCH,but fetch object is undefined");this.api=e,this.emitType=r,this.fetch=o,this.zip=i}return n.prototype.setAbnormalBreaker=function(t){this.abnormalBreaker=t},n.prototype.consume=function(t){return a(this,void 0,void 0,(function(){return c(this,(function(n){switch(n.label){case 0:if(!this.abnormalBreaker.canPass())return[2];t=encodeURIComponent(t),this.zip&&t.length>1e3&&(t=e.gzip(t,{to:"string"})),n.label=1;case 1:switch(n.trys.push([1,11,,12]),this.emitType){case"image":return[3,2];case"xhr":return[3,4];case"fetch":return[3,6];case"beacon":return[3,8]}return[3,10];case 2:return[4,this.imageConsume(t)];case 3:return n.sent(),[3,10];case 4:return[4,this.xhrConsume(t)];case 5:return n.sent(),[3,10];case 6:return[4,this.fetchConsume(t)];case 7:return n.sent(),[3,10];case 8:return[4,this.beaconConsume(t)];case 9:return n.sent(),[3,10];case 10:return[3,12];case 11:return n.sent(),this.abnormalBreaker.count(),[3,12];case 12:return[2]}}))}))},n.prototype.imageConsume=function(t){var e=this,n=new Image;return new Promise((function(r,o){n.onerror=function(t){o(t)},n.onload=function(t){r(t)},n.onabort=function(t){o(t)},n.src=e.api+"?data="+t}))},n.prototype.xhrConsume=function(t){var e=new XMLHttpRequest;return e.open("POST",this.api,!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),new Promise((function(n,r){e.onload=function(t){n(t)},e.onabort=function(t){n(t)},e.onerror=function(t){r(t)},e.onreadystatechange=function(){4===e.readyState&&200===e.status||r(e.readyState)},e.send("data="+t)}))},n.prototype.fetchConsume=function(t){return!!this.fetch&&this.fetch.post(this.api,{data:t})},n.prototype.beaconConsume=function(t){var e=this;return!(!window||!window.navigator||"function"!=typeof window.navigator.sendBeacon)&&new Promise((function(n,r){window.navigator.sendBeacon(e.api,JSON.stringify({data:t}))?n():r()}))},s([p,f],n.prototype,"consume",null),n}(),P=function(){function t(t){this.appName=t,this.store=n.createInstance({name:t,storeName:t})}return t.prototype.destory=function(){this.store.dropInstance({name:this.appName,storeName:this.appName})},t.prototype.shiftMore=function(t){return void 0===t&&(t=10),a(this,void 0,void 0,(function(){var e,n,r,o;return c(this,(function(i){switch(i.label){case 0:return e=[],[4,this.length()];case 1:n=i.sent(),n=t>n?n:t,i.label=2;case 2:return--n>-1?(o=(r=e).push,[4,this._shift()]):[3,4];case 3:return o.apply(r,[i.sent()]),[3,2];case 4:return 0===e.length?[2,""]:[2,e=JSON.stringify(e)]}}))}))},t.prototype._shift=function(){return a(this,void 0,void 0,(function(){var t,e;return c(this,(function(n){switch(n.label){case 0:return t="",[4,this.keys()];case 1:return e=n.sent().shift()||"",[4,this.store.getItem(e)];case 2:return t=n.sent(),[4,this.store.removeItem(e)];case 3:return n.sent(),[2,t]}}))}))},t.prototype.push=function(t){return a(this,void 0,void 0,(function(){var e;return c(this,(function(n){switch(n.label){case 0:return e=this.appName+"_"+(new Date).getTime(),[4,this.store.setItem(e,t)];case 1:return n.sent(),[2]}}))}))},t.prototype.length=function(){return a(this,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return[4,this.store.length()];case 1:return[2,t.sent()]}}))}))},t.prototype.clear=function(){return a(this,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return[4,this.store.clear()];case 1:return[2,t.sent()]}}))}))},t.prototype.keys=function(){return a(this,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return[4,this.store.keys()];case 1:return[2,t.sent()]}}))}))},t.prototype.iterate=function(t){return a(this,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return[4,this.store.iterate(t)];case 1:return[2,e.sent()]}}))}))},t.prototype.customDriver=function(t){return a(this,void 0,void 0,(function(){return c(this,(function(e){return this.store.defineDriver(t),[2]}))}))},t}(),D=function(t){this.provider=t},R=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.listener=function(t){if(t.stopPropagation(),t.preventDefault(),t.target instanceof HTMLImageElement||t.target instanceof HTMLScriptElement||t.target instanceof HTMLLinkElement){var e=t.target instanceof HTMLImageElement||t.target instanceof HTMLScriptElement?t.target.src:t.target instanceof HTMLLinkElement?t.target.href:"";this.provider.track(i(i({},v()),{msg:t.target.outerHTML,file:e,stack:t.target.localName.toUpperCase(),line:0,col:0,ms:"error",ml:"error"}))}else{var n="";if(t.error&&t.error.stack)n=t.error.stack.toString();else if(arguments){for(var r=[],o=arguments.callee.caller,s=3;o&&--s>0&&(r.push(o.toString()),o!==o.caller);)o=o.caller;n=r.join(",")}this.provider.track(i(i({},v()),{file:t.filename,line:t.lineno,col:t.colno,stack:n,msg:t.message,ms:"error",ml:"error"}))}},e.prototype.watch=function(){g("error",this.listener.bind(this))},e.prototype.unwatch=function(){b("error",this.listener.bind(this))},e}(D),j=["click","input","blur"],F=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.getCurrentElement=function(t){var e=t.outerHTML.match("<.+?>");return e&&e[0]||""},e.prototype.listener=function(t){t instanceof MouseEvent?this.provider.track(i(i({},v()),{msg:t.target instanceof HTMLElement?this.getCurrentElement(t.target):"",ms:"action",ml:"info",at:t.type,el:t.target instanceof HTMLElement?this.getCurrentElement(t.target):void 0,x:t.x,y:t.y})):t instanceof FocusEvent?this.provider.track(i(i({},v()),{msg:t.target instanceof HTMLElement?this.getCurrentElement(t.target):"",ms:"action",ml:"info",at:t.type,el:t.target instanceof HTMLElement?this.getCurrentElement(t.target):void 0})):t instanceof KeyboardEvent?this.provider.track(i(i({},v()),{msg:t.type+" "+t.key,ms:"action",ml:"info",at:t.type,key:t.key})):t instanceof InputEvent&&this.provider.track(i(i({},v()),{msg:t.inputType+" "+t.data,ms:"action",ml:"info",at:t.type,key:t.data||""}))},e.prototype.watch=function(){var t,e;try{for(var n=u(j),r=n.next();!r.done;r=n.next()){g(r.value,this.listener.bind(this))}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}},e.prototype.unwatch=function(){var t,e;try{for(var n=u(j),r=n.next();!r.done;r=n.next()){b(r.value,this.listener.bind(this))}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}},e}(D),N=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.listener=function(t){t.stopPropagation(),t.preventDefault(),this.provider.track(i(i({},v()),{msg:t.reason,ms:"uncaught",ml:"error"}))},e.prototype.watch=function(){g("unhandledrejection",this.listener.bind(this))},e.prototype.unwatch=function(){b("unhandledrejection",this.listener.bind(this))},e}(D),B=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.hackState=function(t){l(history,t,(function(e,n,r){l(window,"onpopstate",(function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return window._replace_center_.onpopstate.apply(this,e)}));var o=location.href,i=window._replace_center_[t].apply(history,[e,n,r]);if(!r||r===o)return i;try{var s=o.split("#"),a=r.split("#"),c=_(s[0]),u=_(a[0]),h=s[1]&&s[1].replace(/^\/?(.*)/,"$1"),p=a[1]&&a[1].replace(/^\/?(.*)/,"$1");c!==u?k("historystatechanged",u):h!==p&&k("historystatechanged",p)}catch(t){}return i}))},e.prototype.dehackState=function(t){d(history,t),d(window,"onpopstate")},e.prototype.handleHashchange=function(t){var e=E(location.hash.toLowerCase());S(this.provider,e)},e.prototype.handleHistorystatechange=function(t){var e=E(t.detail.toLowerCase());S(this.provider,e)},e.prototype.watch=function(){this.hackState("pushState"),this.hackState("replaceState"),g("hashchange",this.handleHashchange.bind(this)),g("historystatechanged",this.handleHistorystatechange.bind(this))},e.prototype.unwatch=function(){this.dehackState("pushState"),this.dehackState("replaceState"),b("hashchange",this.handleHashchange.bind(this)),b("historystatechanged",this.handleHistorystatechange.bind(this))},e}(D),q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.listener=function(t){var e=this;setTimeout((function(){e.provider.track(i(i(i({},v()),function(){if(!window.performance)return{};var t=performance.timing;return{dnst:t.domainLookupEnd-t.domainLookupStart||0,tcpt:t.connectEnd-t.connectStart||0,wit:t.responseStart-t.navigationStart||0,domt:t.domContentLoadedEventEnd-t.navigationStart||0,lodt:t.loadEventEnd-t.navigationStart||0,radt:t.fetchStart-t.navigationStart||0,rdit:t.redirectEnd-t.redirectStart||0,uodt:t.unloadEventEnd-t.unloadEventStart||0,reqt:t.responseEnd-t.requestStart||0,andt:t.domComplete-t.domInteractive||0}}()),{ms:"performance",ml:"info"}))}),20)},e.prototype.watch=function(){g("load",this.listener.bind(this))},e.prototype.unwatch=function(){b("load",this.listener.bind(this))},e}(D),z=function(){function t(){this.hooks=new Map}return t.prototype.reigster=function(t,e){for(var n,r=this.hooks.keys();!(n=r.next()).done;)if(n.value===t)throw TypeError('the hook type "'+t+'" already exists！');return this.hooks.set(t,e),this},t.prototype.watch=function(t){var e;if(!this.hooks.has(t))throw TypeError('hook type "'+t+'" does not exist, please register first！');return null===(e=this.hooks.get(t))||void 0===e||e.watch(),this},t.prototype.unwatch=function(t){var e;if(!this.hooks.has(t))throw TypeError('hook type "'+t+'" does not exist, please register first！');return null===(e=this.hooks.get(t))||void 0===e||e.unwatch(),this},t.prototype.initlize=function(t){return this.reigster("error",new R(t)),this.reigster("uncaught",new N(t)),this.reigster("action",new F(t)),this.reigster("spa",new B(t)),this.reigster("performance",new q(t)),this},t}(),A=function(){function t(t){this.consumers=[],this.store=new P(t),this.provider=new T(this.store),this.hooks=(new z).initlize(this.provider),S(this.provider)}return t.prototype.start=function(t,e){var n=this;void 0===t&&(t=15e3),this.timer&&clearInterval(this.timer),this.timer=window.setInterval((function(){return a(n,void 0,void 0,(function(){var t;return c(this,(function(n){switch(n.label){case 0:return[4,this.store.shiftMore(e)];case 1:return t=n.sent(),this.consumers.forEach((function(e){e.consume(t)})),[2]}}))}))}),t)},t.prototype.stop=function(){clearInterval(this.timer),this.timer=void 0},t.prototype.subscribe=function(t,e,n,r){if(!this.store)throw new ReferenceError("The init method has not be invoked, please invoke it before this");return this.consumers.push(new O(t,this.store,e,n,r)),this.consumers[this.consumers.length-1]},t.prototype.getStore=function(){return this.store},t.prototype.getProvider=function(){return this.provider},t}();export{I as CircuitBreaker,A as MonitorCenter,h as lifeCycle};
